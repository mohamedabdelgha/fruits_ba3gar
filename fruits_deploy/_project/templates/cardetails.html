{% load static %}
{% load i18n %}
{% load arabic_numbers %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="{% static "css/main.css" %}">
    <title>تفاصيل النقلة</title>
</head>
<body>
    <header>
        <a href="{% url 'home' %}" class="mainnav">
            <div class="main">
                <img src="{% static "images/logo.png" %}" alt="">
                <h1>تفاصيل النقلة</h1>
            </div>
        </a>
        <a href="{% url "sellcon" container.id %}"><i class="fa-solid fa-arrow-left"></i></a>
    </header>
    <div id="detailwindow" style="width: 50%;">
        <i id="closedetwin" class="fa-solid fa-xmark close" ></i>
        <div id="detailcontainer" style="display: flex; justify-content: center;align-items: center;flex-direction: column;"></div>
    </div>
    <!-- طباعه الفاتوره التى تم انشاؤها-->
    <div id="secprintcon" class="window" style="display: none;">
        <i id="closesecprintcon" class="fa-solid fa-xmark close"></i>
        <i id="secprintbtn" class="fa-solid fa-print printing"></i>
        <div id="printseccontent">
            <img src="{% static "images/printba3ger.png" %}" alt="">
            <table>
                <thead>
                    <tr>
                        <th>العدد</th>
                        <th>الوزن</th>
                        <th>السعر</th>
                        <th>الصنف</th>
                        <th>اجمالي الفاتورة</th>
                    </tr>
                </thead>
                <tbody id="tablebody">
                    <div style="width: 90%;border-radius: 10px;margin: 0; border: 1px solid #625D5D; text-align: center;padding:0px 2px;display: flex;align-items: center;justify-content: space-around;flex-direction: row;">
                        <span style="font-size: 20px;">السيد : {{container.supplier.name}}</span>
                        <span id="secbillDate">date</span>
                    </div><br>
                    {% for bill in container_bills %}
                        <tr>
                            <td>{{ bill.count|arabic_numbers }}</td>
                            <td>{{ bill.weight|arabic_numbers }}</td>
                            <td>{{ bill.price|arabic_numbers }}</td>
                            <td>{{ bill.container_item.item.name }}</td>
                            <td>{{ bill.total_bill_row|arabic_numbers }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="detcon">
                <div>
                    <table class="mintable1">
                        <tbody id="tablebody">
                            <tr>
                                <td>اجمالى النقلة : <span >{{container.total_bill_price|arabic_numbers}}</span> جنيه</td>
                                <td style="display: none;">اجمالى النقلة : <span id="secspan1">{{container.total_bill_price}}</span> جنيه</td>
                            </tr>
                            <tr>
                                <td>الخصومات : <span>{{container.bill_win|arabic_numbers}}</span> جنيه</td>
                                <td style="display: none;">الخصومات : <span id="secspan2">{{container.bill_win}}</span> جنيه</td>
                            </tr>
                            <tr>
                                <td>المصروفات : <span>{{container.total_con_expenses|arabic_numbers}}</span> جنيه</td>
                                <td style="display: none;">المصروفات : <span id="secspan3">{{container.total_con_expenses}}</span> جنيه</td>
                            </tr>
                            <tr  class="head">
                                <td style="border: none;">الصافى : <span id="secspantotal"></span> جنيه</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div>
                    <ul>
                        {% for expense in expenses %}
                        <li><span>{{expense.expense|arabic_numbers}} جنيه </span> : {{expense.expense_type}}</li>
                        {% endfor %}
                        <li>العمولة : <span>{{container.bill_commission|arabic_numbers}} جنيه </span></li>
                        <li>مشال : <span>{{container.carry|arabic_numbers}} جنيه </span></li>
                        <li>ايجار عدة : <span>{{container.tool_rent|arabic_numbers}} جنيه </span></li>
                    </ul>
                    
                </div>
            </div>
        </div>    
    </div>
    <!-- طباعه الفاتوره -->
    <div id="printcon" class="window" style="display: none;">
        <i id="closeprintcon" class="fa-solid fa-xmark close"></i>
        <i id="printbtn" class="fa-solid fa-print printing"></i>
        <div id="printcontent">
            <img src="{% static "images/printba3ger.png" %}" alt="">
            <div style="width: 90%;border-radius: 10px;margin: 0; border: 1px solid #625D5D; text-align: center;padding:0px 2px;display: flex;align-items: center;justify-content: space-around;flex-direction: row;">
                <span style="font-size: 20px;">السيـــد : {{container.supplier.name}}</span>
                <span>تحريراً فــى : <span id="billDate">date</span></span>
            </div><br>
            <table>
                <thead>
                    <tr>
                        <th>المبلغ</th>
                        <th>العدد</th>
                        <th>الوزن</i></th>
                        <th>السعر</th>
                        <th>الصنف</th>
                    </tr>
                </thead>
                <tbody id="tablesellsbody">
                </tbody>
            </table>
            <div class="detcon">
                <div>
                    <table class="mintable1">
                        <tbody id="tablebody">
                            <tr>
                                <td>اجمالى النقلة : <span >{{container.total_sale_price|arabic_numbers}}</span> جنيه</td>
                                <td style="display: none;">اجمالى النقلة : <span id="span1">{{container.total_sale_price}}</span> جنيه</td>
                            </tr>
                            <tr>
                                <td>الخصومات : <span>{{container.win|arabic_numbers}}</span> جنيه</td>
                                <td style="display: none;">الخصومات : <span id="span2">{{container.win}}</span> جنيه</td>
                            </tr>
                            <tr>
                                <td>المصروفات : <span>{{container.total_con_expenses|arabic_numbers}}</span> جنيه</td>
                                <td style="display: none;">المصروفات : <span id="span3">{{container.total_con_expenses}}</span> جنيه</td>
                            </tr>
                            <tr class="head" >
                                <td style="border: none;">الصافى : <span id="spantotal"></span> جنيه</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div>
                    <ul>
                        {% for expense in expenses %}
                            <li><span>جنيه  {{expense.expense|arabic_numbers}}</span> : {{expense.expense_type}} </li>
                        {% endfor %}
                        <li><span>جنيه {{container.main_commission|arabic_numbers}} </span> : العمولة </li>
                        <li><span>جنيه {{container.carry|arabic_numbers}} </span> : مشال </li>
                        <li><span>جنيه {{container.tool_rent|arabic_numbers}} </span> : ايجار عدة </li>
                    </ul>
                    
                </div>
            </div>
        </div>    
    </div>
    <!-- اضافة خصومات للنقلة -->
    <form method ="POST" action="{% url "condetails" container.id %}" class="window" id="profits" style="top: 15%;">
        {% csrf_token %}
        {% for message in messages %}
        <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
        {% endfor %}
        <i id="closeprofits" class="fa-solid fa-xmark close"></i>
        <h2>  اضافة خصومات للنقلة  -----   يرجى ادخال نسبة مئوية فقط في خانة العمولة </h2><h2></h2>
        <div class="inputs">
            <input type="number" name="commission" step="0.001" value="{{container.commission}}" id="" placeholder="العمولة">
            <input type="number" name="carry" value="{{container.carry}}" id="" placeholder="مشال">
            <input type="number" name="tool_rent" value="{{container.tool_rent}}" id="" placeholder="ايجار عدة">
            <button name="profits_submit" id="addprofit">اضافة</button>
        </div>
    </form>
    <!-- اضافة مصروفات للنقلة -->
    <form method ="POST" action="{% url "condetails" container.id %}" class="window" id="loses" style="top: 15%;">
        {% csrf_token %}
        {% for message in messages %}
        <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
        {% endfor %}
        <i id="closeloses" class="fa-solid fa-xmark close"></i>
        <h2>اضافة مصروفات للنقلة</h2>
        <div class="inputs">
            <input type="number" step="0.001" name="expense" id="" placeholder="المبلغ" required >
            <input type="text" name="expense_type" id="" placeholder="نوع المصروف">
            <input type="text" name="expense_notes" id="" placeholder="ملاحظات">
            <button name="loses_submit" id="addlose">اضافة</button>
        </div>
        
    </form>
    <div class="detailscon">
        <h2> اسم العميل: <span>{{container.supplier.name}}</span></h2>
        <h2>التاريخ : <span>{{container.date|date:"20y/m/d"|arabic_numbers}}</span></h2>
        <h2>رقم النقلة : <span>{{ container.id|arabic_numbers }}</span></h2>
        <h2>عدد الاصناف : <span>{{ container.num_of_items|arabic_numbers }}</span></h2>
        <h2>العدد : <span>{{ container.main_total_count|arabic_numbers }}</span></h2>
        <a href="{% url "sellcon" container.id %}"  id="sellcar" class="sellingbtn" style="background-color: #00C2F4; text-decoration:none;">ترحيلات النقلة</a>
    </div>
    <div class="bigcon">
        <div class="right">
            <button id="sales">خصومات</button>
            <ul>
                <li class="head">الربح : <span>{{container.win|arabic_numbers}} جنيه </span></li>
                <li>العمولة : <span>{{container.main_commission|arabic_numbers}} جنيه </span></li>
                <li>مشال : <span>{{container.carry|arabic_numbers}} جنيه </span></li>
                <li>ايجار عدة : <span>{{container.tool_rent|arabic_numbers}} جنيه </span></li>
            </ul>
            <div class="table">
                <table style="width: 100%;">
                    <thead>
                        <tr>
                            <th>المبلغ</th>
                            <th>النوع</th>
                            {% if user.first_name == "شبه مسئول" or user.first_name == 'adminName' %}
                            <th></th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody id="tablebody">
                        {% for expense in expenses %}
                        <tr>
                            <td>{{expense.expense|arabic_numbers}}</td>
                            <td>{{expense.expense_type}}</td>
                            {% if user.first_name == "شبه مسئول" or user.first_name == 'adminName' %}
                            <td><a metadata='
                                {% if user.first_name == "شبه مسئول" or user.first_name == "adminName" %}
                                <h1>هل حقاً تريد حذف المصروف</h1>
                                <br>
                                <i class="fa-regular fa-trash-can" style="color: #ff3333;font-size: 150px;"></i>
                                <br>
                                <form method="POST" class="deleteForm" action="{% url "containerexpensesdelete" id=expense.id %}">
                                    {% csrf_token %}
                                    <a><button class="delete-link" name="expenseDelete" type="submit">حذف</button></a>
                                </form>
                                {% else %}
                                <h1>الحذف غير مفعل</h1>
                                {% endif %}'
                                id="deletecar" class="btn"  style="color: #FF0000;" ><i class="fa-solid fa-trash"></i></a></td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <button id="print" class="print">معاينة الفاتوره</button>
            <button id="deleteoradd" class="deletaadd">مصروفــات</button>
            
        </div>
        <div class="left">
            <div class="detailscon detailscon2">
                <h2>العدد المباع : <span>{{container.total_sold_count|arabic_numbers}} </span></h2>
                <h2>العدد المتبقى : <span>{{container.total_remaining_count|arabic_numbers}}</span></h2>
                <h2>الوزن : <span>{{container.total_sale_weight|arabic_numbers}}</span></h2>
                <h2>اجمالى البيع : <span>{{container.total_sale_price|floatformat:2|arabic_numbers}}</span></h2>
                <h2> اجمالى المصروفات : <span>{{container.total_con_expenses|arabic_numbers}}</span></h2>
                {% if container.weight_difference >= 0 %}
                <h2>فرق الوزن : <span>{{container.weight_difference|arabic_numbers}}</span></h2>
                {% endif %}
                {% if container.price_difference >= 0 %}
                <h2>فرق الفاتورة : <span>{{container.price_difference|floatformat:2|arabic_numbers}}</span></h2>
                {% endif %}
            </div>
            <div class="table">
                <table>
                    <thead>
                        <tr>
                            <th>الصنف</th>
                            <th>العدد</th>
                            <th>السعر</th>
                            <th>الوزن</th>
                            <th>الاجمالى</th>
                            {% if user.first_name == "شبه مسئول" or user.first_name == 'adminName' %}
                            <th></th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody id="tablebody">
                        <h2>اصناف النقلة</h2><br>
                        {% for container_item in container.containeritem_set.all %}
                        <tr>
                            <td>{{ container_item.item.name }}</td>
                            <td>{{ container_item.count|arabic_numbers }}</td>
                            <td>{{ container_item.price|arabic_numbers }}</td>
                            <td>{{ container_item.item_weight|arabic_numbers }}</td>
                            <td>{{ container_item.total_item_price|arabic_numbers }}</td>
                            {% if user.first_name == "شبه مسئول" or user.first_name == 'adminName' %}
                            <td><a metadata='
                                {% if user.first_name == "شبه مسئول" or user.first_name == "adminName" %}
                                <h1>هل حقاً تريد حذف الصنف من النقلة</h1>
                                <h3 style="color:#FF0000;">"حذف الصنف من هذه النقلة سيؤدى الى حذف جميع عمليات البيع المتعلقة به فى النقلة "</h3>
                                <br>
                                <i class="fa-regular fa-trash-can" style="color: #ff3333;font-size: 150px;"></i>
                                <br>
                                <form method="POST" class="deleteForm" action="{% url "containeritemdelete" id=container_item.id %}">
                                    {% csrf_token %}
                                    <a><button class="delete-link" name="containerItemDelete2" type="submit">حذف</button></a>
                                </form>
                                {% else %}
                                <h1>الحذف غير مفعل</h1>
                            {% endif %}' 
                            id="deletecar" class="btn"  style="color: #FF0000;" ><i class="fa-solid fa-trash"></i></a></td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="bills_container">
        <div class="todayscar">
            <div class="title">
                <h1>الفاتورة الاساسية</h1>
            </div>
            <div class="tables">
                
                <table id="originalbilltable">
                    <thead>
                        <tr>
                            <th>المبلغ</th>
                            <th>العدد</th>
                            <th>الوزن</i></th>
                            <th>السعر</th>
                            <th>الصنف</th>
                            <th>التاريخ</th>
                            {% if user.first_name == "شبه مسئول" or user.first_name == 'adminName' %}
                            <th></th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody id="tablesellbody">
                        {% for sale in sales  %}
                        <tr>
                            <td style="display: none;">{{sale.total_sell_price}}</td>
                            <td>{{sale.total_sell_price|arabic_numbers}}</td>
                            <td style="display: none;">{{sale.count}}</td>
                            <td>{{sale.count|arabic_numbers}}</td>
                            <td style="display: none;">{{sale.weight}}</td>
                            <td>{{sale.weight|arabic_numbers}}</td>
                            <td style="display: none;">{{sale.price}}</td>
                            <td>{{sale.price|arabic_numbers}}</td>
                            <td>{{sale.container_item}}</td>
                            <td>{{sale.date|date:"20y/m/d"|arabic_numbers}}</td>
                            {% if user.first_name == "شبه مسئول" or user.first_name == 'adminName' %}
                            <td><a metadata='
                                {% if user.first_name == "شبه مسئول" or user.first_name == "adminName" or user.username == "m" %}
                                <h1>هل حقاً تريد حذف عملية البيع</h1>
                                <br>
                                <i class="fa-regular fa-trash-can" style="color: #ff3333;font-size: 150px;"></i>
                                <br>
                                <form method="POST" class="deleteForm" action="{% url "saledelete" id=sale.id %}">
                                    {% csrf_token %}
                                    <a><button class="delete-link" name="deleteSale2" type="submit">حذف</button></a>
                                </form>
                                {% else %}
                                <h1>الحذف غير مفعل</h1>
                            {% endif %}' 
                            id="deletecar" class="btn"  style="color: #FF0000;" ><i class="fa-solid fa-trash"></i></a></td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="todayscar" id="bills" >
        
        <div class="title">
            <h1>الفاتورة المنشأة</h1>
        </div>
        <div class="tables">
            <button id="printBillBtn" class="print">طباعة</button>
            <form method="POST" action="{% url 'condetails' container.id %}">
                {% csrf_token %}
                {% for message in messages %}
                <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
                {% endfor %}
                <div class="billinputs">
                    <input type="number" name="count" placeholder="العدد" min="1" required>
                    <input type="number" name="weight" step="0.01" placeholder="الوزن"  min="0" required>
                    <input type="number" name="price" step="0.01" placeholder="السعر"  min="0" id="priceInputBill"  required>
                    <select name="container_item" id="kind-select" required>
                        {% for container_item in container_items %}
                            <option value="{{ container_item.id }}" data-price="{{ container_item.price }}">{{ container_item.item.name }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" name="add_bill_submit">اضافة</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>العدد</th>
                            <th>الوزن</th>
                            <th>السعر</th>
                            <th>الصنف</th>
                            <th>اجمالي الفاتورة</th>
                            {% if user.first_name == "شبه مسئول" or user.first_name == "مستخدم متقدم" or user.first_name == 'adminName' %}
                            <th></th>
                            {% endif %}
                            {% if user.first_name == "شبه مسئول" or user.first_name == 'adminName' %}
                            <th></th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody id="tablebody">
                        {% for bill in container_bills %}
                            <tr>
                                <td>{{ bill.count|arabic_numbers }}</td>
                                <td>{{ bill.weight|arabic_numbers }}</td>
                                <td>{{ bill.price|arabic_numbers }}</td>
                                <td>{{ bill.container_item.item.name }}</td>
                                <td>{{ bill.total_bill_row|arabic_numbers }}</td>
                                {% if user.first_name == "شبه مسئول" or user.first_name == "مستخدم متقدم" or user.first_name == 'adminName' %}
                                <td><a metadata='
                                    
                                    {% if user.first_name == "شبه مسئول" or user.first_name == "مستخدم متقدم" or user.first_name == "adminName" %}
                                    <form method="POST" action="{% url "containerbillupdate" bill.id %}" style="display:flex; margin: 10px 0px;justify-content: center;align-items: center;flex-direction: column;">
                                        {% csrf_token %}
                                    <i class="fa-solid fa-clock-rotate-left" style="color: #00F000; font-size:150px;padding:10px ;"></i>
                                    <h2>فاتورة النقلة</h2><br>
                                    <div class="billinputs">
                                        <input type="number" id="count" name="count" placeholder="العدد" required value="{{ bill.count }}"min="1">
                                        <input type="number" name="weight" step="0.001" placeholder="الوزن" required value="{{ bill.weight|floatformat }}" min="0">
                                        <input type="number" name="price" step="0.001" placeholder="السعر" required value="{{ bill.price|floatformat }}" id="priceInputBill" min="1" > 
                                        <select name="container_item" id="kind-select" required>
                                            {% for container_item in container_items %}
                                                <option value="{{ bill.container_item.id }}" data-price="{{ bill.container_item.price }}" {% if container_item.id == container_bill.container_item.id %}selected{% endif %}>{{ container_item.item.name }}</option>
                                            {% endfor %}
                                        </select>
                                        <button type="submit" name="add_bill_submit">تعديل الفاتورة</button>
                                    </div>
                                </form>
                                {% else %}
                                    <h1>التعديل غير مفعل</h1>
                                {% endif %}
                                    ' id="editcar" class="btn" style="color: #00F000;"><i class="fa-regular fa-pen-to-square"></i></a></td>
                                {% endif %}
                                {% if user.first_name == "شبه مسئول" or user.first_name == 'adminName' %}
                                <td><a metadata='    
                                    {% if user.first_name == "شبه مسئول" or user.first_name == "adminName" %}
                                    <h1>هل حقاً تريد حذف خانة الفاتورة من النقلة</h1>
                                    <br>
                                    <i class="fa-regular fa-trash-can" style="color: #ff3333;font-size: 150px;"></i>
                                    <br>
                                    <form method="POST" action="{% url "containerbilldelete" id=bill.id %}">
                                        {% csrf_token %}
                                        <a><button class="delete-link" name="billDelete" type="submit">حذف</button></a>
                                    </form>
                                    {% else %}
                                        <h1>الحذف غير مفعل</h1>
                                    {% endif %}
                                ' id="deletecar" class="btn" style="color: #FF0000;"><i class="fa-solid fa-trash"></i></a></td>
                                {% endif %}
                            </tr>
                        {% endfor %}
                        <tr>
                            <td colspan="4">اجمالى وزن النقلة</td>
                            <td>{{ container.total_bill_weight|arabic_numbers }}</td>
                            <td colspan="2"></td>
                        </tr>
                        <tr>
                            <td colspan="4">اجمالى النقلة</td>
                            <td>{{ total_bill_price|arabic_numbers }}</td>
                            <td colspan="2"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            </form>
        </div>
    </div>
    <script>
    // profits container functions==========================================
    document.getElementById('sales').addEventListener('click',function(){
    document.getElementById('profits').style.display='flex';
    });
    document.getElementById('closeprofits').addEventListener('click',function(){
    document.getElementById('profits').style.display='none';
    });
    // loses container functions==========================================
    document.getElementById('deleteoradd').addEventListener('click',function(){
    document.getElementById('loses').style.display='flex';
    });
    document.getElementById('closeloses').addEventListener('click',function(){
    document.getElementById('loses').style.display='none';
    });
    // print container functions==========================================
    document.getElementById('print').addEventListener('click',function(){
    document.getElementById('printcon').style.display='flex';
    });
    document.getElementById('closeprintcon').addEventListener('click',function(){
        document.getElementById('printcon').style.display='none';
    })
    document.getElementById('printbtn').addEventListener('click', function(){
        printDiv('printcontent')    
    })
    // billPrint container functions==========================================
    document.getElementById('printBillBtn').addEventListener('click',function(){
    document.getElementById('secprintcon').style.display='flex';
    });
    document.getElementById('closesecprintcon').addEventListener('click',function(){
        document.getElementById('secprintcon').style.display='none';
        document.getElementById('tablesellbody').innerHTML=''
    })
    document.getElementById('secprintbtn').addEventListener('click', function(){
        printDiv('printseccontent')    
    })
//======================================================================================================
    const originalTable = document.getElementById("originalbilltable");
    const newTable = document.createElement("table");

    const rowsArray = Array.from(originalTable.rows);
    const dataRows = rowsArray.slice(1); // Exclude the header

    const uniqueRows = [];
    const sumsForDuplicates = new Map();

    dataRows.forEach((row) => {
    const valueAtIndex2 = parseFloat(row.cells[6].textContent);
    const valueAtIndex8 = row.cells[8].textContent;
    const key =  `${valueAtIndex2}-${valueAtIndex8}`;
    const valueAtIndex0 = parseFloat(row.cells[0].textContent);
    const valueAtIndex2ForSum = parseFloat(row.cells[2].textContent);
    const valueAtIndex6ForSum = parseFloat(row.cells[4].textContent); // Add for index 6 sum

    if (!sumsForDuplicates.has(key)) {
        uniqueRows.push(row);
        sumsForDuplicates.set(key, {
        sum0: valueAtIndex0,
        sum2: valueAtIndex2ForSum,
        sum6: valueAtIndex6ForSum, // Store sum for index 6
        });
    } else {
        const sums = sumsForDuplicates.get(key);
        sumsForDuplicates.set(key, {
        sum0: sums.sum0 + valueAtIndex0,
        sum2: sums.sum2 + valueAtIndex2ForSum,
        sum6: sums.sum6 + valueAtIndex6ForSum, // Update sum for index 6
        });
    }
    });

    uniqueRows.forEach((row) => {
        const valueAtIndex2 = parseFloat(row.cells[6].textContent);
        const valueAtIndex8 = row.cells[8].textContent;
        const key =  `${valueAtIndex2}-${valueAtIndex8}`;
        const sums = sumsForDuplicates.get(key);
        const sum0 = sums.sum0.toLocaleString('ar-EG',{
            minimumFractionDigits:0,
            maximumFractionDigits:0
        })
        const sum2 = sums.sum2.toLocaleString('ar-EG',{
            minimumFractionDigits:0,
            maximumFractionDigits:0
        })
        const sum6 = sums.sum6.toLocaleString('ar-EG',{
            minimumFractionDigits:2,
            maximumFractionDigits:2
        })
        console.log(sum0,sum2,sum6)
    const newRow = row.cloneNode(true);
    newRow.cells[1].textContent = sum0; // Set sum for index 0 in index 1
    newRow.cells[3].textContent = sum2; // Set sum for index 2 in index 3
    newRow.cells[5].textContent = sum6; // Set sum for index 6 in index 5

    newRow.deleteCell(newRow.cells.length - 1);
    newRow.deleteCell(newRow.cells.length - 1);

    newTable.appendChild(newRow);
    });    
    document.getElementById('tablesellsbody').innerHTML = newTable.innerHTML
    
//====================================================================================================
    function printDiv(divId) {
        var divToPrint = document.getElementById(divId);
        var newWin = window.open('', '_blank');
        newWin.document.open();
        newWin.document.write(`<html><head><title>Print</title>
        <link rel="stylesheet" href="{% static "css/main.css" %}">
        <style>
        *{
            padding: 0;
            margin: 0;
            box-sizing: border-box;
            /* font-family: 'Tajawal', sans-serif; */
            font-family: Arial, Helvetica, sans-serif;
        }
        body{direction:rtl;display:flex; align-items:start; flex-direction:column;height:100vh;background:#fff;}
        #printcontent table,#printseccontent table{
        width: 90%;
        text-align: center;
        border-radius: 10px;
        overflow: hidden;
        border: 1px solid #040404;
        }
        #printcontent table thead,#printseccontent table thead{
            background-color:#74C785;
        }
        #printcontent table th,#printseccontent table th{
            font-size: 20px;
            color: #000;
            padding: 5px;
            border-bottom: 1px solid #625D5D;
        }
        .detcon table thead{display:none;}
        #printcontent table td,#printseccontent table td{
            font-size: 20px;
            border-bottom: 1px solid #625D5D;
            padding: 5px;
            color: #000;
        }
        #printcontent table td .btn,#printseccontent table td .btn{
            border: none;
            background-color: transparent;
            font-size: 20px;
            cursor: pointer;
        }
        #printcontent,#printseccontent{
            display: flex;
            align-items: center;
            justify-content: start;
            flex-direction: column;
            direction: rtl;
        }
        #printcontent span,#printseccontent span{
            font-size:20px;
            font-weight:500;
        }
        #printcontent .detcon,#printseccontent .detcon{
            margin: 5px;
            width: 90%;
            display: flex;
            justify-content: space-around;
            align-items: start;
            flex-wrap: wrap;
            flex-direction: row;
            border:1px solid #040404;
            border-radius:10px;
        }
        #printcontent .detcon div,#printseccontent .detcon div{width: 45%; text-align: center;}
        #printcontent .detcon table,#printseccontent .detcon table,.detcon ul{
            width: 100%;
            text-align: right;
            border:none;
        }
        #printcontent img,#printseccontent img{
            width: 100%;
        }
        #printcontent h2,#printseccontent h2{
            display:none;
        }
        #printcontent ul,#printseccontent ul{
            width: 100%;
            text-align: start;
            list-style: none;
            background-color: #fff;
            border-radius: 10px;
            overflow: hidden;
            border:none;
        }
        #printcontent .head ,#printseccontent .head {
            background:linear-gradient(270deg,#5A8030,#74C785);
            padding: 5px 10px;
            border:1px solid #000;
        }
        #printcontent .head td,#printseccontent .head td{color:#000;font-size:25px;}
        #printcontent ul li,#printseccontent ul li{
            padding: 5px ;
            font-size: 20px;
            border-bottom:1px solid #625D5D;
            color: #000;
            font-weight: 500;
            text-align: left;
        }
        #printcontent table tr td{border: 1px solid #625D5D;}
        #printcontent .detcon table tr td{border: none; border-bottom: 1px solid #625D5D;}
        </style>
        </head><body>`);
        newWin.document.write(divToPrint.outerHTML);
        newWin.document.write('</body></html>');
        newWin.document.close();
        newWin.print();
        newWin.close();
        window.location.href="{% url 'condetails' container.id %}"
    }
    let span1 = document.getElementById('span1').innerHTML
    let span2 = document.getElementById('span2').innerHTML
    let span3 = document.getElementById('span3').innerHTML
    const currentDate = new Date();
    const month = currentDate.getMonth() + 1
    const armonth=month.toLocaleString('ar-EG',{
        minimumFractionDigits:0,
        maximumFractionDigits:0
    }); // Month is zero-based, so we add 1
    const day = currentDate.getDate().toLocaleString('ar-EG',{
        minimumFractionDigits:0,
        maximumFractionDigits:0
    });
    // Format the date as a string
    const formattedDate = `${armonth}/${day}`;
    document.getElementById('billDate').innerHTML=formattedDate
    let totalcar = parseFloat(span1)-parseFloat(span2)-parseFloat(span3);
    const arabicNumber = totalcar.toLocaleString('ar-EG', {
        minimumFractionDigits: 0, // Ensure a comma separator
        maximumFractionDigits: 0
    });
    document.getElementById('spantotal').innerHTML = arabicNumber;
    //================================================================================
    let secspan1 = document.getElementById('secspan1').innerHTML
    let secspan2 = document.getElementById('secspan2').innerHTML
    let secspan3 = document.getElementById('secspan3').innerHTML
    let sectotalcar =  parseFloat(secspan1)-parseFloat(secspan2)-parseFloat(secspan3);
    const secarabicNumber = sectotalcar.toLocaleString('ar-EG', {
        minimumFractionDigits: 0, // Ensure a comma separator
        maximumFractionDigits: 0
    });
    document.getElementById('secbillDate').innerHTML=formattedDate
    document.getElementById('secspantotal').innerHTML = secarabicNumber;
    const editcar = document.querySelectorAll('#editcar')
        const deletecar = document.querySelectorAll('#deletecar')
        const closedetwin = document.getElementById('closedetwin')
        editcar.forEach((btn)=>{
            btn.onclick=()=>{
                const metadata = btn.getAttribute('metadata')
                document.getElementById('detailwindow').style.top='30%'
                document.getElementById('detailwindow').style.visibility='visible'
                document.getElementById('detailwindow').style.transform='scale(1)'
                document.getElementById('detailcontainer').innerHTML=metadata
            }
        })
        deletecar.forEach((btn)=>{
            btn.onclick=()=>{
                const metadata = btn.getAttribute('metadata')
                document.getElementById('detailwindow').style.top='30%'
                document.getElementById('detailwindow').style.visibility='visible'
                document.getElementById('detailwindow').style.transform='scale(1)'
                document.getElementById('detailcontainer').innerHTML=metadata
            }
        })
        closedetwin.addEventListener('click',()=>{
            document.getElementById('detailwindow').style.top='0'
            document.getElementById('detailwindow').style.visibility='hidden'
            document.getElementById('detailwindow').style.transform='scale(0)'
        })
        // Get all date input elements
        const dateInputs = document.querySelectorAll('input[type="date"]');

        // Get today's date
        const today = new Date();

        // Loop through each input and set its value to today's date
        dateInputs.forEach(input => {
        input.value = today.toISOString().split('T')[0];
        });

    </script>
</body>
</html>
